version: 2.1
orbs:
  protobuf: izumin5210/protobuf@0.1.0
jobs:
  build:
    docker:
      - image: circleci/node:7.10

    working_directory: ~/repo

    steps:
      - checkout

      # GRPC CPP is built from source. Try to restore the latest release from cache.
      - restore_cache:
          keys:
            - grpc-build

      - protobuf/install
      - run:
          name: "Install Linter"
          command: |
            sudo curl -sSL https://github.com/uber/prototool/releases/download/v1.8.0/prototool-$(uname -s)-$(uname -m) -o /usr/local/bin/prototool
            sudo chmod +x /usr/local/bin/prototool
      # Install GRPC if there was not a cache hit.
      - run:
          name: "Install GRPC"
          command: |
            if [ ! -d ~/grpc ]; then
            cd ~
            git clone -b $(curl -L https://grpc.io/release) https://github.com/grpc/grpc
            cd grpc
            git submodule update --init
            make
            fi

      - run: mkdir -p generated

      - run:
          name: "Compile GRPC Protocol Buffers Services"
          command: |
            protoc --proto_path=./proto/ --cpp_out ./generated/  --grpc_out=./generated --plugin=protoc-gen-grpc=../grpc/bins/opt/grpc_cpp_plugin ./proto/*.proto

      - run:
          name: "Lint"
          command:
            prototool lint

      - run:
          name: "Check Breakages"
          command:
            prototool break check

      # Save built GRPC artifacts to cache.
      - save_cache:
          key: grpc-build
          paths:
            - ~/grpc/
